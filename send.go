package main

import (
	"fmt"
	"net"
	"os"
	"strconv"
	"time"
)

func main() {
	serverAddr, err := net.ResolveUDPAddr("udp", "cookz.no-ip.org:1337")

	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	localAddr, err := net.ResolveUDPAddr("udp", ":1337")
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	conn, err := net.DialUDP("udp", localAddr, serverAddr)
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	bytesPerSecond := 1024 * 512.0 // 0.5mb/s
	buf := make([]byte, 1024)
	packetsPerSecond := bytesPerSecond / float64(len(buf))
	packetDelay := 1000 / packetsPerSecond

	fmt.Printf("Sending 1 packet each %f ms\n\n", packetDelay)

	defer conn.Close()
	i := 0
	for {
		msg := strconv.Itoa(i)
		i++
		integer := []byte(msg)
		copy(buf, integer)
		_, err := conn.Write(buf)
		if err != nil {
			fmt.Println(err)
			os.Exit(1)
		}
		time.Sleep(time.Millisecond * time.Duration(packetDelay))
	}
}
