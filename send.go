package main

import (
	"fmt"
	"net"
	"os"
	"strconv"
	"time"
)

func main() {
	//serverAddr, err := net.ResolveUDPAddr("udp", "cookz.no-ip.org:1337")
	serverAddr, err := net.ResolveUDPAddr("udp", "127.0.0.1:1337")
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	localAddr, err := net.ResolveUDPAddr("udp", ":0")
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	conn, err := net.DialUDP("udp", localAddr, serverAddr)
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	err = conn.SetWriteBuffer(1024 * 1024)
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	bytesPerSecond := 1024 * 512.0 // 0.5mb/s
	buf := make([]byte, 1024)
	packetsPerSecond := int(bytesPerSecond / float64(len(buf)))

	defer conn.Close()
	i := 0
	for {

		now := time.Now()
		for j := 0; j < packetsPerSecond; j++ {
			msg := strconv.Itoa(i)
			i++
			integer := []byte(msg)
			copy(buf, integer)
			_, err := conn.Write(buf)
			if err != nil {
				fmt.Println(err)
				os.Exit(1)
			}
		}
		dur := time.Now().Sub(now).Seconds()

		if dur >= 1.0 {
			continue
		}

		fmt.Printf("Sending process took %f seconds\n", dur)

		dur = 1.0 - dur
		timeToWait := time.Duration(dur * float64(time.Second))

		time.Sleep(timeToWait)
	}
}
